<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Summary - Soft Flight Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Global Country Data -->
    <script>
        window.GLOBAL_COUNTRIES = [
            { code: '+880', name: 'Bangladesh', flag: 'üáßüá©', display: 'üáßüá© Bangladesh (+880)' },
            { code: '+1', name: 'United States', flag: 'üá∫üá∏', display: 'üá∫üá∏ United States (+1)' },
            { code: '+1', name: 'Canada', flag: 'üá®üá¶', display: 'üá®üá¶ Canada (+1)' },
            { code: '+44', name: 'United Kingdom', flag: 'üá¨üáß', display: 'üá¨üáß United Kingdom (+44)' },
            { code: '+33', name: 'France', flag: 'üá´üá∑', display: 'üá´üá∑ France (+33)' },
            { code: '+49', name: 'Germany', flag: 'üá©üá™', display: 'üá©üá™ Germany (+49)' },
            { code: '+39', name: 'Italy', flag: 'üáÆüáπ', display: 'üáÆüáπ Italy (+39)' },
            { code: '+34', name: 'Spain', flag: 'üá™üá∏', display: 'üá™üá∏ Spain (+34)' },
            { code: '+86', name: 'China', flag: 'üá®üá≥', display: 'üá®üá≥ China (+86)' },
            { code: '+81', name: 'Japan', flag: 'üáØüáµ', display: 'üáØüáµ Japan (+81)' },
            { code: '+82', name: 'South Korea', flag: 'üá∞üá∑', display: 'üá∞üá∑ South Korea (+82)' },
            { code: '+91', name: 'India', flag: 'üáÆüá≥', display: 'üáÆüá≥ India (+91)' },
            { code: '+61', name: 'Australia', flag: 'üá¶üá∫', display: 'üá¶üá∫ Australia (+61)' },
            { code: '+64', name: 'New Zealand', flag: 'üá≥üáø', display: 'üá≥üáø New Zealand (+64)' },
            { code: '+92', name: 'Pakistan', flag: 'üáµüá∞', display: 'üáµüá∞ Pakistan (+92)' },
            { code: '+52', name: 'Mexico', flag: 'üá≤üáΩ', display: 'üá≤üáΩ Mexico (+52)' },
            { code: '+55', name: 'Brazil', flag: 'üáßüá∑', display: 'üáßüá∑ Brazil (+55)' },
            { code: '+7', name: 'Russia', flag: 'üá∑üá∫', display: 'üá∑üá∫ Russia (+7)' },
            { code: '+27', name: 'South Africa', flag: 'üáøüá¶', display: 'üáøüá¶ South Africa (+27)' },
            { code: '+971', name: 'UAE', flag: 'üá¶üá™', display: 'üá¶üá™ UAE (+971)' },
            { code: '+966', name: 'Saudi Arabia', flag: 'üá∏üá¶', display: 'üá∏üá¶ Saudi Arabia (+966)' },
            { code: '+65', name: 'Singapore', flag: 'üá∏üá¨', display: 'üá∏üá¨ Singapore (+65)' },
            { code: '+60', name: 'Malaysia', flag: 'üá≤üáæ', display: 'üá≤üáæ Malaysia (+60)' },
            { code: '+66', name: 'Thailand', flag: 'üáπüá≠', display: 'üáπüá≠ Thailand (+66)' },
            { code: '+84', name: 'Vietnam', flag: 'üáªüá≥', display: 'üáªüá≥ Vietnam (+84)' },
            { code: '+63', name: 'Philippines', flag: 'üáµüá≠', display: 'üáµüá≠ Philippines (+63)' },
            { code: '+62', name: 'Indonesia', flag: 'üáÆüá©', display: 'üáÆüá© Indonesia (+62)' },
            { code: '+90', name: 'Turkey', flag: 'üáπüá∑', display: 'üáπüá∑ Turkey (+90)' },
            { code: '+98', name: 'Iran', flag: 'üáÆüá∑', display: 'üáÆüá∑ Iran (+98)' },
            { code: '+20', name: 'Egypt', flag: 'üá™üá¨', display: 'üá™üá¨ Egypt (+20)' },
            { code: '+234', name: 'Nigeria', flag: 'üá≥üá¨', display: 'üá≥üá¨ Nigeria (+234)' },
            { code: '+254', name: 'Kenya', flag: 'üá∞üá™', display: 'üá∞üá™ Kenya (+254)' },
            { code: '+233', name: 'Ghana', flag: 'üá¨üá≠', display: 'üá¨üá≠ Ghana (+233)' },
            { code: '+212', name: 'Morocco', flag: 'üá≤üá¶', display: 'üá≤üá¶ Morocco (+212)' },
            { code: '+213', name: 'Algeria', flag: 'üá©üáø', display: 'üá©üáø Algeria (+213)' },
            { code: '+216', name: 'Tunisia', flag: 'üáπüá≥', display: 'üáπüá≥ Tunisia (+216)' },
            { code: '+218', name: 'Libya', flag: 'üá±üáæ', display: 'üá±üáæ Libya (+218)' },
            { code: '+251', name: 'Ethiopia', flag: 'üá™üáπ', display: 'üá™üáπ Ethiopia (+251)' },
            { code: '+256', name: 'Uganda', flag: 'üá∫üá¨', display: 'üá∫üá¨ Uganda (+256)' },
            { code: '+255', name: 'Tanzania', flag: 'üáπüáø', display: 'üáπüáø Tanzania (+255)' },
            { code: '+94', name: 'Sri Lanka', flag: 'üá±üá∞', display: 'üá±üá∞ Sri Lanka (+94)' },
            { code: '+95', name: 'Myanmar', flag: 'üá≤üá≤', display: 'üá≤üá≤ Myanmar (+95)' },
            { code: '+977', name: 'Nepal', flag: 'üá≥üáµ', display: 'üá≥üáµ Nepal (+977)' },
            { code: '+975', name: 'Bhutan', flag: 'üáßüáπ', display: 'üáßüáπ Bhutan (+975)' },
            { code: '+960', name: 'Maldives', flag: 'üá≤üáª', display: 'üá≤üáª Maldives (+960)' },
            { code: '+93', name: 'Afghanistan', flag: 'üá¶üá´', display: 'üá¶üá´ Afghanistan (+93)' },
            { code: '+380', name: 'Ukraine', flag: 'üá∫üá¶', display: 'üá∫üá¶ Ukraine (+380)' },
            { code: '+48', name: 'Poland', flag: 'üáµüá±', display: 'üáµüá± Poland (+48)' },
            { code: '+31', name: 'Netherlands', flag: 'üá≥üá±', display: 'üá≥üá± Netherlands (+31)' },
            { code: '+32', name: 'Belgium', flag: 'üáßüá™', display: 'üáßüá™ Belgium (+32)' },
            { code: '+41', name: 'Switzerland', flag: 'üá®üá≠', display: 'üá®üá≠ Switzerland (+41)' },
            { code: '+43', name: 'Austria', flag: 'üá¶üáπ', display: 'üá¶üáπ Austria (+43)' },
            { code: '+45', name: 'Denmark', flag: 'üá©üá∞', display: 'üá©üá∞ Denmark (+45)' },
            { code: '+46', name: 'Sweden', flag: 'üá∏üá™', display: 'üá∏üá™ Sweden (+46)' },
            { code: '+47', name: 'Norway', flag: 'üá≥üá¥', display: 'üá≥üá¥ Norway (+47)' },
            { code: '+358', name: 'Finland', flag: 'üá´üáÆ', display: 'üá´üáÆ Finland (+358)' },
            { code: '+353', name: 'Ireland', flag: 'üáÆüá™', display: 'üáÆüá™ Ireland (+353)' },
            { code: '+351', name: 'Portugal', flag: 'üáµüáπ', display: 'üáµüáπ Portugal (+351)' },
            { code: '+30', name: 'Greece', flag: 'üá¨üá∑', display: 'üá¨üá∑ Greece (+30)' },
            { code: '+420', name: 'Czech Republic', flag: 'üá®üáø', display: 'üá®üáø Czech Republic (+420)' },
            { code: '+421', name: 'Slovakia', flag: 'üá∏üá∞', display: 'üá∏üá∞ Slovakia (+421)' },
            { code: '+36', name: 'Hungary', flag: 'üá≠üá∫', display: 'üá≠üá∫ Hungary (+36)' },
            { code: '+40', name: 'Romania', flag: 'üá∑üá¥', display: 'üá∑üá¥ Romania (+40)' },
            { code: '+359', name: 'Bulgaria', flag: 'üáßüá¨', display: 'üáßüá¨ Bulgaria (+359)' },
            { code: '+385', name: 'Croatia', flag: 'üá≠üá∑', display: 'üá≠üá∑ Croatia (+385)' },
            { code: '+386', name: 'Slovenia', flag: 'üá∏üáÆ', display: 'üá∏üáÆ Slovenia (+386)' },
            { code: '+387', name: 'Bosnia and Herzegovina', flag: 'üáßüá¶', display: 'üáßüá¶ Bosnia and Herzegovina (+387)' },
            { code: '+381', name: 'Serbia', flag: 'üá∑üá∏', display: 'üá∑üá∏ Serbia (+381)' },
            { code: '+382', name: 'Montenegro', flag: 'üá≤üá™', display: 'üá≤üá™ Montenegro (+382)' },
            { code: '+383', name: 'Kosovo', flag: 'üáΩüá∞', display: 'üáΩüá∞ Kosovo (+383)' },
            { code: '+389', name: 'North Macedonia', flag: 'üá≤üá∞', display: 'üá≤üá∞ North Macedonia (+389)' },
            { code: '+355', name: 'Albania', flag: 'üá¶üá±', display: 'üá¶üá± Albania (+355)' },
            { code: '+372', name: 'Estonia', flag: 'üá™üá™', display: 'üá™üá™ Estonia (+372)' },
            { code: '+371', name: 'Latvia', flag: 'üá±üáª', display: 'üá±üáª Latvia (+371)' },
            { code: '+370', name: 'Lithuania', flag: 'üá±üáπ', display: 'üá±üáπ Lithuania (+370)' },
            { code: '+375', name: 'Belarus', flag: 'üáßüáæ', display: 'üáßüáæ Belarus (+375)' },
            { code: '+373', name: 'Moldova', flag: 'üá≤üá©', display: 'üá≤üá© Moldova (+373)' },
            { code: '+374', name: 'Armenia', flag: 'üá¶üá≤', display: 'üá¶üá≤ Armenia (+374)' },
            { code: '+995', name: 'Georgia', flag: 'üá¨üá™', display: 'üá¨üá™ Georgia (+995)' },
            { code: '+994', name: 'Azerbaijan', flag: 'üá¶üáø', display: 'üá¶üáø Azerbaijan (+994)' },
            { code: '+996', name: 'Kyrgyzstan', flag: 'üá∞üá¨', display: 'üá∞üá¨ Kyrgyzstan (+996)' },
            { code: '+998', name: 'Uzbekistan', flag: 'üá∫üáø', display: 'üá∫üáø Uzbekistan (+998)' },
            { code: '+992', name: 'Tajikistan', flag: 'üáπüáØ', display: 'üáπüáØ Tajikistan (+992)' },
            { code: '+993', name: 'Turkmenistan', flag: 'üáπüá≤', display: 'üáπüá≤ Turkmenistan (+993)' },
            { code: '+7', name: 'Kazakhstan', flag: 'üá∞üáø', display: 'üá∞üáø Kazakhstan (+7)' }
        ];

        // Helper functions for country data
        window.getCountryByCode = function(code) {
            return window.GLOBAL_COUNTRIES.find(country => country.code === code) || window.GLOBAL_COUNTRIES[0];
        };

        window.getCountryDisplay = function(code) {
            const country = window.getCountryByCode(code);
            return `${country.flag} ${country.code}`;
        };

        window.generateCountryOptions = function() {
            return window.GLOBAL_COUNTRIES.map(country => 
                `<div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="${country.code}" data-name="${country.name}">${country.display}</div>`
            ).join('');
        };

        // Global nationality data - will be loaded from API
        window.GLOBAL_NATIONALITIES = [];

        // Load nationalities on page load
        window.loadNationalities = async function() {
            try {
                const response = await axios.get('/api/countries');
                if (response.data.success) {
                    window.GLOBAL_NATIONALITIES = response.data.data;
                    console.log('Loaded', window.GLOBAL_NATIONALITIES.length, 'nationalities');
                }
            } catch (error) {
                console.error('Failed to load nationalities:', error);
            }
        };

        // Search nationalities
        window.searchNationalities = function(query) {
            if (!query) return window.GLOBAL_NATIONALITIES;
            const lowerQuery = query.toLowerCase();
            return window.GLOBAL_NATIONALITIES.filter(country => 
                country.name.toLowerCase().includes(lowerQuery) ||
                country.nationality.toLowerCase().includes(lowerQuery) ||
                country.code.toLowerCase().includes(lowerQuery)
            );
        };
    </script>
    <link rel="stylesheet" href="components/nav.css">
    <script src="components/nav.js"></script>
    <style>
        /* Global Loader Styles */
        .global-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease-in-out;
        }
        
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #f97316;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .section-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
            min-height: 120px;
        }
        
        .section-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #f97316;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- Global Loader -->
    <div id="global-loader" class="global-loader">
        <div class="loader-spinner"></div>
        <div class="mt-4 text-center">
            <h3 class="text-lg font-semibold text-gray-700">Loading Booking Summary...</h3>
            <p class="text-sm text-gray-500 mt-2">Please wait while we prepare your booking details</p>
        </div>
    </div>
    
    <!-- Navigation will be inserted here -->
    
    <!-- Header -->
    <div class="py-8 mt-4">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-3xl font-bold text-gray-800">‚úàÔ∏è Flight Booking Summary</h1>
            <p class="text-gray-600 mt-2">Please review your booking details before proceeding to payment</p>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Two Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Column - Passenger Information (Scrollable) -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Passenger Information Card -->
                <div class="bg-white rounded-lg shadow-lg">
                    <div class="border-b border-gray-200 px-6 py-4">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            Passenger Information
                        </h2>
                    </div>
                    <div class="p-6">
                        <!-- Passenger Forms Loader -->
                        <div id="passenger-forms-loader" class="section-loader">
                            <div class="section-spinner"></div>
                            <span class="ml-3 text-gray-600">Loading passenger forms...</span>
                        </div>
                        
                        <div id="passenger-forms-container" class="hidden">
                            <!-- Passenger forms will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 justify-between">
                    <button id="back-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Back to Edit
                    </button>
                    
                    <button id="proceed-payment-btn" class="bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-700 hover:to-orange-600 text-white font-bold py-3 px-8 rounded-lg transition duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                        </svg>
                        Proceed to Payment
                        <div id="payment-loading" class="hidden ml-2">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Right Column - Fixed (Timer, Flight Details, Price Summary) -->
            <div class="lg:col-span-1">
                <div class="lg:sticky lg:top-20 space-y-6">
                    
                    <!-- Booking Timer -->
                    <div id="booking-timer-container"></div>
                    
                    <!-- Flight Details Card -->
                    <div class="bg-white rounded-lg shadow-lg">
                        <div class="border-b border-gray-200 px-4 py-3">
                            <div class="flex items-center justify-between">
                                <h2 class="text-lg font-bold text-gray-800 flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                    </svg>
                                    Flight Details
                                </h2>
                                <button id="view-flight-details-btn" class="text-orange-600 hover:text-orange-700 text-sm font-semibold transition duration-200">
                                    Details ‚Üí
                                </button>
                            </div>
                        </div>
                        <div class="p-4">
                            <!-- Flight Details Loader -->
                            <div id="flight-details-loader" class="section-loader">
                                <div class="section-spinner"></div>
                                <span class="ml-3 text-gray-600 text-sm">Loading...</span>
                            </div>
                            
                            <div id="flight-details-content" class="space-y-3 hidden">
                                <!-- Flight details will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Price Breakdown Card -->
                    <div class="bg-white rounded-lg shadow-lg">
                        <div class="border-b border-gray-200 px-4 py-3">
                            <h2 class="text-lg font-bold text-gray-800 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                                Price Summary
                            </h2>
                        </div>
                        <div class="p-4">
                            <!-- Price Details Loader -->
                            <div id="price-details-loader" class="section-loader">
                                <div class="section-spinner"></div>
                                <span class="ml-3 text-gray-600 text-sm">Loading...</span>
                            </div>
                            
                            <div id="price-details-content" class="hidden">
                                <!-- Price details will be populated here -->
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>

            <!-- Messages -->
            <div id="messages" class="mt-6"></div>
        </div>
    </div>

    <!-- Timer Expired Modal -->
    <div id="timerExpiredModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden animate-fadeIn">
            <div class="bg-gradient-to-r from-red-500 to-red-600 px-6 py-5 text-center">
                <div class="flex justify-center mb-3">
                    <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center">
                        <svg class="w-10 h-10 text-red-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/>
                        </svg>
                    </div>
                </div>
                <h2 class="text-2xl font-bold text-white">Time Expired!</h2>
            </div>
            
            <div class="p-8 text-center">
                <p class="text-gray-700 text-lg mb-6">
                    Your booking time has expired. Please search for flights again to start a new booking.
                </p>
                
                <button id="goToHomeBtn" class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-4 px-6 rounded-xl transition duration-300 flex items-center justify-center shadow-lg">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    Go to Home
                </button>
            </div>
        </div>
    </div>

    <!-- Flight Details Modal -->
    <div id="flightDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden animate-fadeIn flex flex-col">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-orange-500 to-orange-600 px-6 py-4 flex items-center justify-between flex-shrink-0">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                    </svg>
                    Flight Details
                </h2>
                <button id="closeFlightDetailsModal" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="overflow-y-auto flex-1 custom-scrollbar">
                <div id="flightDetailsModalContent" class="p-6">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        .animate-fadeIn {
            animation: fadeIn 0.2s ease-out;
        }
        
        /* Custom scrollbar for modal */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #ff9800;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #f57c00;
        }

        /* Nationality dropdown custom scrollbar */
        .nationality-dropdown-menu::-webkit-scrollbar {
            width: 8px;
        }
        .nationality-dropdown-menu::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .nationality-dropdown-menu::-webkit-scrollbar-thumb {
            background: #ff9800;
            border-radius: 10px;
        }
        .nationality-dropdown-menu::-webkit-scrollbar-thumb:hover {
            background: #f57c00;
        }

        /* Nationality option hover effect */
        .nationality-option {
            transition: background-color 0.2s ease;
        }
    </style>

    <!-- Footer -->
    <footer id="footer-component"></footer>

    <script>
        class BookingSummaryManager {
            constructor() {
                this.bookingData = null;
                this.init();
            }

            init() {
                // Load booking data from localStorage
                this.loadBookingData();
                this.setupEventListeners();
                this.displaySummary();
            }

            loadBookingData() {
                const bookingDataStr = localStorage.getItem('pending_booking_data');
                if (!bookingDataStr) {
                    alert('No booking data found. Redirecting to flights page...');
                    window.location.href = '/flights.html';
                    return;
                }
                this.bookingData = JSON.parse(bookingDataStr);
                console.log('üìã Loaded booking data for summary:', this.bookingData);
                console.log('üé´ Offer slices count:', this.bookingData.offer?.slices?.length);
                console.log('üé´ Offer slices:', this.bookingData.offer?.slices);
            }

            setupEventListeners() {
                // Back button
                document.getElementById('back-btn').addEventListener('click', () => {
                    this.goBackToFlightSearch();
                });

                // Proceed to payment button
                document.getElementById('proceed-payment-btn').addEventListener('click', () => {
                    this.proceedToPayment();
                });
                
                // View flight details button
                document.getElementById('view-flight-details-btn')?.addEventListener('click', () => {
                    this.showFlightDetailsModal();
                });
                
                // Close modal button
                document.getElementById('closeFlightDetailsModal')?.addEventListener('click', () => {
                    this.closeFlightDetailsModal();
                });
                
                // Close modal on background click
                document.getElementById('flightDetailsModal')?.addEventListener('click', (e) => {
                    if (e.target.id === 'flightDetailsModal') {
                        this.closeFlightDetailsModal();
                    }
                });
            }

            goBackToFlightSearch() {
                // Get the original flight search URL from localStorage or reconstruct from booking data
                let originalSearchUrl = localStorage.getItem('original_search_url');
                
                if (!originalSearchUrl && this.bookingData?.searchData) {
                    // Reconstruct the search URL from booking data
                    const searchParams = new URLSearchParams();
                    
                    // Basic search parameters
                    searchParams.set('type', '1'); // One way (default)
                    searchParams.set('departure_id', this.extractAirportCode(this.bookingData.flightDetails.route, 'origin'));
                    searchParams.set('arrival_id', this.extractAirportCode(this.bookingData.flightDetails.route, 'destination'));
                    
                    // Date parameter from flight details
                    if (this.bookingData.flightDetails.departure) {
                        const departureDate = new Date(this.bookingData.flightDetails.departure);
                        const formattedDate = departureDate.toISOString().split('T')[0];
                        searchParams.set('outbound_date', formattedDate);
                    } else {
                        // Use today's date as fallback
                        const today = new Date();
                        const formattedDate = today.toISOString().split('T')[0];
                        searchParams.set('outbound_date', formattedDate);
                    }
                    
                    // Passenger parameters
                    const searchData = this.bookingData.searchData;
                    searchParams.set('adults', searchData.adults || 1);
                    if (searchData.children && searchData.children > 0) {
                        searchParams.set('children', searchData.children);
                    }
                    if (searchData.infants && searchData.infants > 0) {
                        searchParams.set('infants', searchData.infants);
                    }
                    
                    // Additional parameters
                    searchParams.set('travel_class', '1'); // Economy (default)
                    searchParams.set('fare_type', '1'); // Regular fare (default)
                    
                    originalSearchUrl = `/flights.html?${searchParams.toString()}`;
                }
                
                // Fallback to basic flights page if no URL can be constructed
                const backUrl = originalSearchUrl || '/flights.html';
                
                console.log('üîô Going back to flight search:', backUrl);
                window.location.href = backUrl;
            }

            extractAirportCode(route, position) {
                // Extract airport codes from route like "DAC ‚Üí CGP"
                const parts = route.split(' ‚Üí ');
                if (position === 'origin' && parts.length > 0) {
                    return parts[0].trim();
                } else if (position === 'destination' && parts.length > 1) {
                    return parts[1].trim();
                }
                return '';
            }

            displaySummary() {
                this.displayFlightDetails();
                this.displayPassengerForms();
                this.displayPriceDetails();
            }

            displayFlightDetails() {
                const container = document.getElementById('flight-details-content');
                
                // Minimal loading delay for UX
                setTimeout(() => {
                
                // Check if we have the complete offer data
                const offer = this.bookingData.offer;
                
                // Debug: Check what's in offer.slices
                console.log('üîç Flight Details - Number of slices:', offer?.slices?.length);
                console.log('üîç Flight Details - Slices data:', offer?.slices);
                
                if (!offer || !offer.slices) {
                    // Fallback to basic flight details
                    const { flightDetails } = this.bookingData;
                    const departureDate = new Date(flightDetails.departure).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric'
                    });
                    
                    const departureTime = new Date(flightDetails.departure).toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    container.innerHTML = `
                        <div class="space-y-2 text-sm">
                            <div class="font-semibold text-gray-800">${flightDetails.route}</div>
                            <div class="text-gray-600">${flightDetails.airline}</div>
                            <div class="text-gray-600">${departureDate} ‚Ä¢ ${departureTime}</div>
                        </div>
                    `;
                } else {
                    // Enhanced display with full offer data
                    let slicesHtml = '';
                    
                    offer.slices.forEach((slice, sliceIndex) => {
                        const isRoundTrip = offer.slices.length > 1;
                        const sliceLabel = isRoundTrip ? (sliceIndex === 0 ? 'Outbound' : 'Return') : '';
                        
                        slice.segments.forEach((segment, segIndex) => {
                            const departureTime = new Date(segment.departing_at).toLocaleTimeString('en-US', {
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false
                            });
                            
                            const arrivalTime = new Date(segment.arriving_at).toLocaleTimeString('en-US', {
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false
                            });
                            
                            const departureDate = new Date(segment.departing_at).toLocaleDateString('en-US', {
                                month: 'short',
                                day: 'numeric'
                            });
                            
                            const airline = segment.marketing_carrier?.name || segment.operating_carrier?.name || 'Unknown';
                            const flightNumber = segment.marketing_carrier_flight_number || segment.operating_carrier_flight_number || '';
                            
                            // Calculate duration - handle multiple formats
                            let durationText = '';
                            if (segment.duration) {
                                // If duration is a string (ISO format like "PT1H5M")
                                if (typeof segment.duration === 'string') {
                                    const match = segment.duration.match(/PT(\d+H)?(\d+M)?/);
                                    if (match) {
                                        const hours = match[1] ? parseInt(match[1]) : 0;
                                        const minutes = match[2] ? parseInt(match[2]) : 0;
                                        durationText = `${hours}h ${minutes}m`;
                                    }
                                } else {
                                    // If duration is in minutes (number)
                                    const hours = Math.floor(segment.duration / 60);
                                    const minutes = segment.duration % 60;
                                    durationText = `${hours}h ${minutes}m`;
                                }
                            }
                            
                            // Fallback: calculate from departure and arrival times if duration is missing
                            if (!durationText) {
                                const depDate = new Date(segment.departing_at);
                                const arrDate = new Date(segment.arriving_at);
                                const durationMs = arrDate.getTime() - depDate.getTime();
                                const totalMinutes = Math.floor(durationMs / 60000);
                                const hours = Math.floor(totalMinutes / 60);
                                const minutes = totalMinutes % 60;
                                durationText = `${hours}h ${minutes}m`;
                            }
                            
                            slicesHtml += `
                                ${sliceLabel && segIndex === 0 ? `<div class="text-xs font-semibold text-orange-600 mb-2">${sliceLabel}</div>` : ''}
                                <div class="border-b border-gray-100 pb-3 mb-3">
                                    <div class="text-xs text-gray-500 mb-1">${departureDate}</div>
                                    <div class="flex items-center justify-between mb-1">
                                        <div class="text-sm font-bold text-gray-800">${segment.origin.iata_code}</div>
                                        <div class="flex-1 mx-2 border-t border-gray-300 relative">
                                            <svg class="w-3 h-3 text-orange-500 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                                            </svg>
                                        </div>
                                        <div class="text-sm font-bold text-gray-800">${segment.destination.iata_code}</div>
                                    </div>
                                    <div class="flex items-center justify-between text-xs">
                                        <div class="text-gray-600">${departureTime}</div>
                                        <div class="text-gray-500">${durationText}</div>
                                        <div class="text-gray-600">${arrivalTime}</div>
                                    </div>
                                    <div class="text-xs text-gray-600 mt-1">
                                        <div>${airline} ${flightNumber}</div>
                                    </div>
                                </div>
                            `;
                        });
                    });
                    
                    container.innerHTML = `<div class="space-y-2">${slicesHtml}</div>`;
                }
                
                // Show flight details section after content is loaded
                LoaderManager.showSection('flight-details');
                
                }, 100); // Reduced delay for faster loading
            }

            displayPassengerForms() {
                // CRITICAL: Use passengers from Duffel offer (with correct IDs) or initialize if missing
                const searchData = this.bookingData?.searchData;
                
                // Check if we have offer_request_passengers with Duffel IDs
                if (this.bookingData.offer_request_passengers && this.bookingData.offer_request_passengers.length > 0) {
                    console.log('‚úÖ Using passengers from Duffel offer with correct IDs:', this.bookingData.offer_request_passengers);
                    
                    // Initialize passengers with Duffel IDs and add required booking fields
                    this.bookingData.passengers = this.bookingData.offer_request_passengers.map(passenger => ({
                        // PRESERVE DUFFEL ID - CRITICAL!
                        id: passenger.id,
                        type: passenger.type,
                        
                        // Add required booking fields (empty, to be filled by user)
                        title: '',
                        given_name: '',
                        family_name: '',
                        email: '',
                        phone_number: '',
                        born_on: '',
                        gender: '', // Required by Duffel API (auto-set from title)
                        nationality: '', // Required field
                        
                        // Preserve any additional Duffel fields
                        age: passenger.age || null,
                        loyalty_programme_accounts: passenger.loyalty_programme_accounts || []
                    }));
                } else if (!this.bookingData.passengers || this.bookingData.passengers.length === 0) {
                    console.warn('‚ö†Ô∏è No Duffel passengers found, creating fallback passengers (this may cause booking errors)');
                    this.bookingData.passengers = [];
                    
                    // Fallback: Add adult passengers (this should not normally happen)
                    const adults = searchData?.adults || 1;
                    for (let i = 0; i < adults; i++) {
                        this.bookingData.passengers.push({
                            id: null, // Will cause Duffel error - user needs to re-search
                            type: 'adult',
                            title: '',
                            given_name: '',
                            family_name: '',
                            email: '',
                            phone_number: '',
                            born_on: '',
                            gender: '', // Required by Duffel API (auto-set from title)
                            nationality: '' // Required field
                        });
                    }
                    
                    // Add child passengers (fallback)
                    const children = searchData?.children || 0;
                    for (let i = 0; i < children; i++) {
                        this.bookingData.passengers.push({
                            id: null, // Will cause Duffel error - user needs to re-search
                            type: 'child',
                            title: '',
                            given_name: '',
                            family_name: '',
                            email: '',
                            phone_number: '',
                            born_on: '',
                            gender: '', // Required by Duffel API (auto-set from title)
                            nationality: '' // Required field
                        });
                    }
                    
                    // Add infant passengers (fallback)
                    const infants = searchData?.infants || 0;
                    for (let i = 0; i < infants; i++) {
                        this.bookingData.passengers.push({
                            id: null, // Will cause Duffel error - user needs to re-search
                            type: 'infant_without_seat',
                            title: '',
                            given_name: '',
                            family_name: '',
                            email: '',
                            phone_number: '',
                            born_on: '',
                            gender: '', // Required by Duffel API (auto-set from title)
                            nationality: '' // Required field
                        });
                    }
                }
                
                // Ensure all passengers have required fields for Duffel API
                this.bookingData.passengers.forEach(passenger => {
                    if (!passenger.gender) {
                        passenger.gender = '';
                    }
                });
                
                this.renderPassengerForms();
            }

            renderPassengerForms() {
                // Minimal loading for better UX
                setTimeout(() => {
                    const container = document.getElementById('passenger-forms-container');
                    const passengers = this.bookingData.passengers;
                    
                    let formsHtml = '';
                    passengers.forEach((passenger, index) => {
                        formsHtml += this.generatePassengerForm(passenger, index, passengers);
                    });
                    
                    container.innerHTML = formsHtml;
                    this.setupPassengerFormEventListeners();
                    
                    // Show passenger forms section
                    LoaderManager.showSection('passenger-forms');
                    
                    // Populate traveller dropdowns after rendering forms with a small delay
                    console.log('üîÑ Forms rendered, populating traveller dropdowns...');
                    setTimeout(() => {
                        console.log('üìù Calling populateTravellerDropdowns...');
                        window.populateTravellerDropdowns();
                    }, 100);
                    
                }, 150); // Reduced delay for faster loading
            }

            generatePassengerForm(passenger, index, passengers) {
                return `
                    <div class="border-l-4 border-orange-500 pl-6 mb-6 bg-gray-50 p-4 rounded-r-lg" data-passenger-index="${index}">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-semibold text-lg text-gray-800">
                                Passenger ${index + 1}
                                <span class="ml-2 text-sm px-3 py-1 rounded-full ${
                                    passenger.type === 'adult' ? 'bg-blue-100 text-blue-800' : 
                                    passenger.type === 'child' ? 'bg-green-100 text-green-800' : 
                                    'bg-purple-100 text-purple-800'
                                }">
                                    ${passenger.type === 'adult' ? 'Adult' : 
                                      passenger.type === 'child' ? 'Child' : 
                                      'Infant'}
                                </span>
                            </h3>
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700">Quick Select:</label>
                                <select id="travellerSelect_${index}" class="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white" onchange="populateFromTraveller(${index})">
                                    <option value="">Choose existing traveller...</option>
                                    <!-- Travellers will be populated here -->
                                </select>
                            </div>
                        </div>

                        <!-- Compact Two-Column Form Layout -->
                        <div class="space-y-4">
                            <!-- Row 1: Title (Radio Buttons) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-3">Title <span class="text-red-500">*</span></label>
                                <div class="flex flex-wrap gap-4">
                                    ${passenger.type === 'adult' ? `
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="radio" name="title_${index}" value="mr" class="passenger-title w-4 h-4 text-orange-500 focus:ring-orange-500" ${passenger.title === 'mr' ? 'checked' : ''} required>
                                            <span class="text-gray-700">Mr.</span>
                                        </label>
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="radio" name="title_${index}" value="mrs" class="passenger-title w-4 h-4 text-orange-500 focus:ring-orange-500" ${passenger.title === 'mrs' ? 'checked' : ''} required>
                                            <span class="text-gray-700">Mrs.</span>
                                        </label>
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="radio" name="title_${index}" value="ms" class="passenger-title w-4 h-4 text-orange-500 focus:ring-orange-500" ${passenger.title === 'ms' ? 'checked' : ''} required>
                                            <span class="text-gray-700">Ms.</span>
                                        </label>
                                    ` : `
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="radio" name="title_${index}" value="mstr" class="passenger-title w-4 h-4 text-orange-500 focus:ring-orange-500" ${passenger.title === 'mstr' ? 'checked' : ''} required>
                                            <span class="text-gray-700">Mstr.</span>
                                        </label>
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="radio" name="title_${index}" value="miss" class="passenger-title w-4 h-4 text-orange-500 focus:ring-orange-500" ${passenger.title === 'miss' ? 'checked' : ''} required>
                                            <span class="text-gray-700">Miss.</span>
                                        </label>
                                    `}
                                </div>
                            </div>

                            <!-- Row 2: First Name and Last Name -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">First Name <span class="text-red-500">*</span></label>
                                    <input type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2 passenger-first-name" 
                                           value="${passenger.given_name || ''}" placeholder="Enter first name" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Last Name <span class="text-red-500">*</span></label>
                                    <input type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2 passenger-last-name" 
                                           value="${passenger.family_name || ''}" placeholder="Enter last name" required>
                                </div>
                            </div>

                            <!-- Row 3: Date of Birth and Nationality -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Date of Birth <span class="text-red-500">*</span></label>
                                    <input type="date" class="w-full border border-gray-300 rounded-lg px-3 py-2 passenger-dob" 
                                           value="${passenger.born_on || ''}" required>
                                </div>
                                <div class="relative">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nationality <span class="text-red-500">*</span></label>
                                    <div class="relative nationality-search-dropdown">
                                        <input type="text" 
                                               class="w-full border border-gray-300 rounded-lg px-3 py-2 passenger-nationality-search" 
                                               placeholder="üåç Search country..." 
                                               value="${passenger.nationality || ''}"
                                               autocomplete="off">
                                        <input type="hidden" class="passenger-nationality" value="${passenger.nationality || ''}" required>
                                        <div class="absolute z-50 mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden nationality-dropdown-menu">
                                            <!-- Dropdown will be populated dynamically -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Hidden Gender Field (Auto-set from title) -->
                            <input type="hidden" class="passenger-gender" value="${passenger.gender || ''}">

                            <!-- Row 4: Email and Phone Number -->
                            ${passenger.type === 'child' ? `
                                <!-- Email Only (Full Width) for Children -->
                                <div class="passenger-email-field">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email ${index === 0 && passenger.type === 'adult' ? '<span class="text-red-500">*</span>' : ''}</label>
                                    <input type="email" class="w-full border border-gray-300 rounded-lg px-3 py-2 passenger-email" 
                                           value="${passenger.email || ''}" placeholder="Enter email address" ${index === 0 && passenger.type === 'adult' ? 'required' : ''}>
                                </div>
                            ` : `
                                <!-- Email and Phone (Two Columns) for Adults and Infants -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="passenger-email-field">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email ${index === 0 && passenger.type === 'adult' ? '<span class="text-red-500">*</span>' : ''}</label>
                                        <input type="email" class="w-full border border-gray-300 rounded-lg px-3 py-2 passenger-email" 
                                               value="${passenger.email || ''}" placeholder="Enter email address" ${index === 0 && passenger.type === 'adult' ? 'required' : ''}>
                                    </div>
                                    <div class="passenger-phone-field">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number <span class="text-red-500">*</span></label>
                                        <div class="flex">
                                            <div class="relative country-search-dropdown" style="width: 140px;">
                                                <input type="text" 
                                                       class="border border-gray-300 rounded-l-lg px-3 py-2 bg-white passenger-country-search w-full cursor-pointer" 
                                                       placeholder="üåç Search..." 
                                                       readonly 
                                                       value="${(() => {
                                                           const phone = passenger.phone_number || '';
                                                           if (phone.startsWith('+1')) return 'üáßüá© +880';
                                                           if (phone.startsWith('+44')) return 'üá¨üáß +44';
                                                           if (phone.startsWith('+33')) return 'üá´üá∑ +33';
                                                           if (phone.startsWith('+49')) return 'ÔøΩÔøΩ +49';
                                                           if (phone.startsWith('+39')) return 'üáÆüáπ +39';
                                                           if (phone.startsWith('+34')) return 'üá™üá∏ +34';
                                                           if (phone.startsWith('+86')) return 'üá®üá≥ +86';
                                                           if (phone.startsWith('+81')) return 'üáØüáµ +81';
                                                           if (phone.startsWith('+82')) return 'ÔøΩüá∑ +82';
                                                           if (phone.startsWith('+91')) return 'üáÆüá≥ +91';
                                                           if (phone.startsWith('+61')) return 'üá¶üá∫ +61';
                                                           if (phone.startsWith('+64')) return 'ÔøΩÔøΩ +64';
                                                           if (phone.startsWith('+880')) return 'üáßüá© +880';
                                                           if (phone.startsWith('+92')) return 'üáµüá∞ +92';
                                                           if (phone.startsWith('+52')) return 'üá≤üáΩ +52';
                                                           if (phone.startsWith('+55')) return 'üáßüá∑ +55';
                                                           if (phone.startsWith('+7')) return 'üá∑üá∫ +7';
                                                           if (phone.startsWith('+27')) return 'üáøüá¶ +27';
                                                           return window.getCountryDisplay('+880');
                                                       })()}">
                                                <div class="absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none">
                                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                    </svg>
                                                </div>
                                                <div class="country-dropdown-options absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg z-50 max-h-60 overflow-y-auto hidden">
                                                    <div class="p-2">
                                                        <input type="text" class="w-full px-3 py-2 border border-gray-200 rounded country-filter" placeholder="Search country...">
                                                    </div>
                                                    <div class="country-options-list">
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+1" data-name="United States">üá∫üá∏ United States (+1)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+44" data-name="United Kingdom">üá¨üáß United Kingdom (+44)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+33" data-name="France">ÔøΩÔøΩ France (+33)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+49" data-name="Germany">üá©üá™ Germany (+49)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+39" data-name="Italy">üáÆüáπ Italy (+39)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+34" data-name="Spain">ÔøΩÔøΩ Spain (+34)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+86" data-name="China">üá®üá≥ China (+86)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+81" data-name="Japan">üáØüáµ Japan (+81)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+82" data-name="South Korea">üá∞üá∑ South Korea (+82)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+91" data-name="India">üáÆüá≥ India (+91)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+61" data-name="Australia">üá¶üá∫ Australia (+61)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+64" data-name="New Zealand">üáø New Zealand (+64)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+880" data-name="Bangladesh">üáßüá© Bangladesh (+880)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+92" data-name="Pakistan">üáµüá∞ Pakistan (+92)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+52" data-name="Mexico">ÔøΩÔøΩ Mexico (+52)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+55" data-name="Brazil">üáßüá∑ Brazil (+55)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+7" data-name="Russia">üá∑üá∫ Russia (+7)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+27" data-name="South Africa">üáøüá¶ South Africa (+27)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+971" data-name="UAE">ÔøΩÔøΩ UAE (+971)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+966" data-name="Saudi Arabia">üá∏üá¶ Saudi Arabia (+966)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+65" data-name="Singapore">üá∏üá¨ Singapore (+65)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+60" data-name="Malaysia">ÔøΩÔøΩ Malaysia (+60)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+66" data-name="Thailand">üáπüá≠ Thailand (+66)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+84" data-name="Vietnam">üáªüá≥ Vietnam (+84)</div>
                                                        <div class="country-option px-3 py-2 hover:bg-gray-50 cursor-pointer" data-code="+63" data-name="Philippines">üáµÔøΩ Philippines (+63)</div>
                                                    </div>
                                                </div>
                                                <input type="hidden" class="passenger-country-code" value="${(() => {
                                                    const phone = passenger.phone_number || '';
                                                    for (const country of window.GLOBAL_COUNTRIES) {
                                                        if (phone.startsWith(country.code)) {
                                                            return country.code;
                                                        }
                                                    }
                                                    return '+880'; // Default to Bangladesh
                                                })()}">
                                            </div>
                                            <input type="tel" class="flex-1 border border-l-0 border-gray-300 rounded-r-lg px-3 py-2 passenger-phone-number" 
                                                   value="${(passenger.phone_number || '').replace(/^\+\d{1,4}/, '')}" placeholder="Enter phone number" required>
                                        </div>
                                    </div>
                                </div>
                            `}

                            ${passenger.type === 'child' ? 
                                `<div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <p class="text-sm text-blue-700">
                                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Email and phone will use Adult 1's information
                                    </p>
                                </div>` : ''
                            }
                        </div>
                    </div>
                `;
            }

            setupPassengerFormEventListeners() {
                // Input field listeners for real-time updates
                const container = document.getElementById('passenger-forms-container');
                // Remove existing listeners to prevent duplicates
                const newContainer = container.cloneNode(true);
                container.parentNode.replaceChild(newContainer, container);
                
                // Add fresh listeners
                newContainer.addEventListener('input', (e) => {
                    this.updatePassengerData(e);
                });
                newContainer.addEventListener('change', (e) => {
                    this.updatePassengerData(e);
                });

                // Country search dropdown functionality
                this.setupCountrySearchListeners(newContainer);
                
                // Nationality search dropdown functionality
                this.setupNationalitySearchListeners(newContainer);
                
                // Populate country dropdowns with global data
                this.populateCountryDropdowns(newContainer);
            }

            populateCountryDropdowns(container) {
                const countryLists = container.querySelectorAll('.country-options-list');
                countryLists.forEach(list => {
                    list.innerHTML = window.generateCountryOptions();
                });
            }

            setupCountrySearchListeners(container) {
                // Country search input click to open dropdown
                container.addEventListener('click', (e) => {
                    if (e.target.classList.contains('passenger-country-search')) {
                        const dropdown = e.target.closest('.country-search-dropdown');
                        const options = dropdown.querySelector('.country-dropdown-options');
                        
                        // Close all other dropdowns first
                        document.querySelectorAll('.country-dropdown-options').forEach(opt => {
                            if (opt !== options) opt.classList.add('hidden');
                        });
                        
                        // Toggle this dropdown
                        options.classList.toggle('hidden');
                        
                        // Focus on search input
                        const searchInput = options.querySelector('.country-filter');
                        if (searchInput) {
                            setTimeout(() => searchInput.focus(), 100);
                        }
                    }
                });

                // Country search filter functionality
                container.addEventListener('input', (e) => {
                    if (e.target.classList.contains('country-filter')) {
                        const searchTerm = e.target.value.toLowerCase();
                        const dropdown = e.target.closest('.country-dropdown-options');
                        const options = dropdown.querySelectorAll('.country-option');
                        
                        options.forEach(option => {
                            const countryName = option.dataset.name.toLowerCase();
                            const countryCode = option.dataset.code.toLowerCase();
                            const optionText = option.textContent.toLowerCase();
                            
                            if (countryName.includes(searchTerm) || 
                                countryCode.includes(searchTerm) || 
                                optionText.includes(searchTerm)) {
                                option.style.display = 'block';
                            } else {
                                option.style.display = 'none';
                            }
                        });
                    }
                });

                // Country option selection
                container.addEventListener('click', (e) => {
                    if (e.target.classList.contains('country-option')) {
                        const option = e.target;
                        const dropdown = option.closest('.country-search-dropdown');
                        const searchInput = dropdown.querySelector('.passenger-country-search');
                        const hiddenInput = dropdown.querySelector('.passenger-country-code');
                        const optionsContainer = dropdown.querySelector('.country-dropdown-options');
                        
                        // Get selected values
                        const countryCode = option.dataset.code;
                        const countryName = option.dataset.name;
                        const flag = option.textContent.split(' ')[0]; // Get emoji flag
                        
                        // Update inputs
                        searchInput.value = `${flag} ${countryCode}`;
                        hiddenInput.value = countryCode;
                        
                        // Hide dropdown
                        optionsContainer.classList.add('hidden');
                        
                        // Reset search filter
                        const filterInput = optionsContainer.querySelector('.country-filter');
                        if (filterInput) {
                            filterInput.value = '';
                            // Show all options again
                            optionsContainer.querySelectorAll('.country-option').forEach(opt => {
                                opt.style.display = 'block';
                            });
                        }
                        
                        // Trigger phone number update
                        const phoneInput = dropdown.parentNode.querySelector('.passenger-phone-number');
                        if (phoneInput) {
                            const changeEvent = new Event('change', { bubbles: true });
                            phoneInput.dispatchEvent(changeEvent);
                        }
                    }
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.country-search-dropdown')) {
                        document.querySelectorAll('.country-dropdown-options').forEach(options => {
                            options.classList.add('hidden');
                        });
                    }
                });
            }

            setupNationalitySearchListeners(container) {
                // Nationality search input
                container.addEventListener('input', (e) => {
                    if (e.target.classList.contains('passenger-nationality-search')) {
                        const searchInput = e.target;
                        const dropdown = searchInput.closest('.nationality-search-dropdown');
                        const menu = dropdown.querySelector('.nationality-dropdown-menu');
                        const searchTerm = searchInput.value;

                        // Show dropdown when typing
                        if (searchTerm.length > 0) {
                            const results = window.searchNationalities(searchTerm);
                            
                            if (results.length > 0) {
                                menu.innerHTML = results.slice(0, 50).map(country => 
                                    `<div class="nationality-option px-3 py-2 hover:bg-gray-50 cursor-pointer" 
                                          data-code="${country.code}" 
                                          data-nationality="${country.nationality}">
                                        ${country.name}
                                    </div>`
                                ).join('');
                                menu.classList.remove('hidden');
                            } else {
                                menu.innerHTML = '<div class="px-3 py-2 text-gray-500">No results found</div>';
                                menu.classList.remove('hidden');
                            }
                        } else {
                            // Show all when empty
                            menu.innerHTML = window.GLOBAL_NATIONALITIES.slice(0, 50).map(country => 
                                `<div class="nationality-option px-3 py-2 hover:bg-gray-50 cursor-pointer" 
                                      data-code="${country.code}" 
                                      data-nationality="${country.nationality}">
                                    ${country.name}
                                </div>`
                            ).join('');
                            menu.classList.remove('hidden');
                        }
                    }
                });

                // Nationality option selection
                container.addEventListener('click', (e) => {
                    if (e.target.classList.contains('nationality-option')) {
                        const option = e.target;
                        const dropdown = option.closest('.nationality-search-dropdown');
                        const searchInput = dropdown.querySelector('.passenger-nationality-search');
                        const hiddenInput = dropdown.querySelector('.passenger-nationality');
                        const menu = dropdown.querySelector('.nationality-dropdown-menu');
                        
                        const nationality = option.dataset.nationality;
                        
                        // Update inputs
                        searchInput.value = nationality;
                        hiddenInput.value = nationality;
                        
                        // Hide dropdown
                        menu.classList.add('hidden');
                        
                        // Trigger change event for validation
                        const changeEvent = new Event('change', { bubbles: true });
                        hiddenInput.dispatchEvent(changeEvent);
                    }
                });

                // Show dropdown on focus
                container.addEventListener('focus', (e) => {
                    if (e.target.classList.contains('passenger-nationality-search')) {
                        const dropdown = e.target.closest('.nationality-search-dropdown');
                        const menu = dropdown.querySelector('.nationality-dropdown-menu');
                        
                        // Populate with all options if empty
                        if (menu.children.length === 0) {
                            menu.innerHTML = window.GLOBAL_NATIONALITIES.slice(0, 50).map(country => 
                                `<div class="nationality-option px-3 py-2 hover:bg-gray-50 cursor-pointer" 
                                      data-code="${country.code}" 
                                      data-nationality="${country.nationality}">
                                    ${country.name}
                                </div>`
                            ).join('');
                        }
                        menu.classList.remove('hidden');
                    }
                }, true);

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.nationality-search-dropdown')) {
                        document.querySelectorAll('.nationality-dropdown-menu').forEach(menu => {
                            menu.classList.add('hidden');
                        });
                    }
                });
            }



            updatePassengerData(event) {
                const target = event.target;
                const passengerDiv = target.closest('[data-passenger-index]');
                if (!passengerDiv) return;

                const index = parseInt(passengerDiv.dataset.passengerIndex);
                const passenger = this.bookingData.passengers[index];

                if (target.classList.contains('passenger-title')) {
                    passenger.title = target.value;
                    
                    // Auto-set gender based on title
                    const genderInput = passengerDiv.querySelector('.passenger-gender');
                    if (target.value === 'mr' || target.value === 'mstr') {
                        passenger.gender = 'm';
                        if (genderInput) genderInput.value = 'm';
                    } else if (target.value === 'mrs' || target.value === 'ms' || target.value === 'miss') {
                        passenger.gender = 'f';
                        if (genderInput) genderInput.value = 'f';
                    }
                } else if (target.classList.contains('passenger-first-name')) {
                    passenger.given_name = target.value;
                } else if (target.classList.contains('passenger-last-name')) {
                    passenger.family_name = target.value;
                } else if (target.classList.contains('passenger-dob')) {
                    passenger.born_on = target.value;
                } else if (target.classList.contains('passenger-gender')) {
                    passenger.gender = target.value;
                } else if (target.classList.contains('passenger-nationality')) {
                    passenger.nationality = target.value;
                } else if (target.classList.contains('passenger-email')) {
                    passenger.email = target.value;
                } else if (target.classList.contains('passenger-phone-number') || target.classList.contains('passenger-country-code')) {
                    // Combine country code and phone number
                    const passengerDiv = target.closest('[data-passenger-index]');
                    const countryCodeSelect = passengerDiv.querySelector('.passenger-country-code');
                    const phoneInput = passengerDiv.querySelector('.passenger-phone-number');
                    
                    if (countryCodeSelect && phoneInput) {
                        const countryCode = countryCodeSelect.value;
                        const phoneNumber = phoneInput.value;
                        passenger.phone_number = phoneNumber ? countryCode + phoneNumber : '';
                    }
                }

                // Save to localStorage
                localStorage.setItem('pending_booking_data', JSON.stringify(this.bookingData));
                this.updatePriceDetails();
            }

            updatePriceDetails() {
                this.displayPriceDetails();
            }

            displayPriceDetails() {
                // Minimal loading for better UX
                setTimeout(() => {
                    // Calculate total based on passenger count (basic calculation)
                    const baseAmount = parseFloat(this.bookingData.total_amount || 0);
                    const passengerCount = this.bookingData.passengers?.length || 1;
                    const originalPassengerCount = this.bookingData.searchData?.passengers || 1;
                    
                    // Adjust price based on passenger count change
                    const adjustedAmount = (baseAmount / originalPassengerCount) * passengerCount;
                    
                    const { total_currency } = this.bookingData;
                    const container = document.getElementById('price-details-content');
                    
                    container.innerHTML = `
                        <div class="space-y-3">
                            <div class="flex justify-between text-lg">
                                <span class="text-gray-600">Base Fare (${passengerCount} passenger${passengerCount > 1 ? 's' : ''}):</span>
                                <span class="font-medium">${total_currency} ${adjustedAmount.toFixed(2)}</span>
                            </div>
                            <div class="border-t border-gray-200 pt-3">
                                <div class="flex justify-between text-xl font-bold text-blue-600">
                                    <span>Total Amount:</span>
                                    <span>${total_currency} ${adjustedAmount.toFixed(2)}</span>
                                </div>
                            </div>
                            <div class="text-sm text-gray-500 mt-2">
                                * All prices are inclusive of applicable taxes and fees
                            </div>
                        </div>
                    `;
                    
                    // Show price details section
                    LoaderManager.showSection('price-details');
                    
                }, 200); // Reduced delay for faster loading
            }

            showFlightDetailsModal() {
                const modal = document.getElementById('flightDetailsModal');
                const modalContent = document.getElementById('flightDetailsModalContent');
                
                const offer = this.bookingData.offer;
                
                if (!offer || !offer.slices) {
                    modalContent.innerHTML = '<p class="text-gray-600">Flight details not available.</p>';
                    modal.classList.remove('hidden');
                    return;
                }
                
                // Check if it's a round trip
                const isRoundTrip = offer.slices.length > 1;
                let currentSliceIndex = 0;
                
                const renderSliceDetails = (sliceIndex) => {
                    const slice = offer.slices[sliceIndex];
                    const sliceLabel = isRoundTrip ? (sliceIndex === 0 ? 'Depart' : 'Return') : 'Flight';
                    const route = `${slice.segments[0].origin.iata_code} - ${slice.segments[slice.segments.length - 1].destination.iata_code}`;
                    
                    let detailsHtml = '';
                    
                    // Radio buttons for round trip - Modern Design
                    if (isRoundTrip) {
                        detailsHtml += `
                            <div class="mb-6 flex gap-2 bg-gray-50 p-1.5 rounded-lg">
                                ${offer.slices.map((s, idx) => {
                                    const label = idx === 0 ? 'Depart' : 'Return';
                                    const originCode = s.segments[0].origin.iata_code;
                                    const destCode = s.segments[s.segments.length - 1].destination.iata_code;
                                    const r = `${originCode} - ${destCode}`;
                                    const isActive = idx === sliceIndex;
                                    return `
                                        <label class="flex-1 cursor-pointer">
                                            <input type="radio" name="flightSlice" value="${idx}" 
                                                ${isActive ? 'checked' : ''} 
                                                class="hidden peer">
                                            <div class="flex items-center justify-center gap-2 px-3 py-2 rounded-md transition-all
                                                ${isActive ? 'bg-orange-500 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-100'}">
                                                <div class="w-3.5 h-3.5 rounded-full border-2 ${isActive ? 'border-white bg-white' : 'border-gray-400'}
                                                    flex items-center justify-center">
                                                    ${isActive ? '<div class="w-1.5 h-1.5 rounded-full bg-orange-500"></div>' : ''}
                                                </div>
                                                <span class="text-sm font-semibold">${r} (${label})</span>
                                            </div>
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    }
                    
                    // Render each segment with modern design
                    slice.segments.forEach((segment, segIndex) => {
                        const departureDate = new Date(segment.departing_at);
                        const arrivalDate = new Date(segment.arriving_at);
                        
                        const depTime = departureDate.toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        });
                        
                        const depDateFormatted = departureDate.toLocaleDateString('en-US', {
                            day: 'numeric',
                            month: 'short',
                            weekday: 'long'
                        });
                        
                        const arrTime = arrivalDate.toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        });
                        
                        const arrDateFormatted = arrivalDate.toLocaleDateString('en-US', {
                            day: 'numeric',
                            month: 'short',
                            weekday: 'long'
                        });
                        
                        const airline = segment.marketing_carrier?.name || segment.operating_carrier?.name || 'Unknown';
                        const flightNumber = segment.marketing_carrier_flight_number || segment.operating_carrier_flight_number || '';
                        const aircraftName = segment.aircraft?.name || '';
                        
                        const originCity = segment.origin.city_name || segment.origin.name;
                        const originAirport = segment.origin.name;
                        const destCity = segment.destination.city_name || segment.destination.name;
                        const destAirport = segment.destination.name;
                        
                        const cabinClass = segment.passengers?.[0]?.cabin_class_marketing_name || 'Economy';
                        const cabinCode = segment.passengers?.[0]?.cabin_class || 'economy';
                        
                        // Calculate duration - handle both ISO duration and minutes
                        let durationText = '';
                        if (segment.duration) {
                            // If duration is a string (ISO format like "PT1H5M")
                            if (typeof segment.duration === 'string') {
                                const match = segment.duration.match(/PT(\d+H)?(\d+M)?/);
                                if (match) {
                                    const hours = match[1] ? parseInt(match[1]) : 0;
                                    const minutes = match[2] ? parseInt(match[2]) : 0;
                                    durationText = `${hours}h ${minutes}m`;
                                }
                            } else {
                                // If duration is in minutes (number)
                                const hours = Math.floor(segment.duration / 60);
                                const minutes = segment.duration % 60;
                                durationText = `${hours}h ${minutes}m`;
                            }
                        } else {
                            // Calculate from departure and arrival times
                            const durationMs = arrivalDate.getTime() - departureDate.getTime();
                            const totalMinutes = Math.floor(durationMs / 60000);
                            const hours = Math.floor(totalMinutes / 60);
                            const minutes = totalMinutes % 60;
                            durationText = `${hours}h ${minutes}m`;
                        }
                        
                        detailsHtml += `
                            <div class="bg-gradient-to-br from-gray-50 to-white rounded-xl p-5 mb-4 shadow-md hover:shadow-lg transition-all">
                                <!-- Departure Section -->
                                <div class="flex items-start mb-5 pb-5 border-b border-gray-100">
                                    <div class="flex-shrink-0 mt-1">
                                        <div class="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center">
                                            <svg class="w-5 h-5 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                                                <circle cx="10" cy="10" r="6"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 flex-1">
                                        <div class="flex items-baseline gap-3 mb-1">
                                            <span class="text-2xl font-bold text-gray-900">${depTime}</span>
                                            <span class="text-gray-500 text-xs font-medium">${depDateFormatted}</span>
                                        </div>
                                        <div class="text-base font-bold text-gray-800 mb-1">Departure, ${originCity}</div>
                                        <div class="flex items-center gap-2">
                                            <span class="inline-block px-2 py-0.5 bg-gray-800 text-white text-xs font-bold rounded">
                                                ${segment.origin.iata_code}
                                            </span>
                                            <span class="text-gray-600 text-xs">${originAirport}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Flight Info Section -->
                                <div class="flex items-start mb-5 pb-5 border-b border-gray-100">
                                    <div class="flex-shrink-0 mt-1">
                                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                            <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 flex-1">
                                        <div class="flex items-center justify-between mb-2">
                                            <div>
                                                <div class="text-base font-bold text-gray-900 mb-1">${airline}</div>
                                                <div class="text-gray-600 text-xs">
                                                    ${flightNumber ? 'Flight ' + flightNumber : ''}
                                                    ${aircraftName ? ' ‚Ä¢ ' + aircraftName : ''}
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-gray-500 text-xs font-medium mb-0.5">Duration</div>
                                                <div class="text-sm font-bold text-gray-900">${durationText}</div>
                                            </div>
                                        </div>
                                        <div class="flex gap-2 mt-2">
                                            <span class="inline-block px-3 py-1 bg-gradient-to-r from-orange-500 to-red-500 text-white text-xs font-bold rounded-lg shadow-md">
                                                ${cabinClass} (${cabinCode.charAt(0).toUpperCase()})
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Arrival Section -->
                                <div class="flex items-start">
                                    <div class="flex-shrink-0 mt-1">
                                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                            <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="ml-4 flex-1">
                                        <div class="flex items-baseline gap-3 mb-1">
                                            <span class="text-2xl font-bold text-gray-900">${arrTime}</span>
                                            <span class="text-gray-500 text-xs font-medium">${arrDateFormatted}</span>
                                        </div>
                                        <div class="text-base font-bold text-gray-800 mb-1">Arrival, ${destCity}</div>
                                        <div class="flex items-center gap-2">
                                            <span class="inline-block px-2 py-0.5 bg-gray-800 text-white text-xs font-bold rounded">
                                                ${segment.destination.iata_code}
                                            </span>
                                            <span class="text-gray-600 text-xs">${destAirport}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    modalContent.innerHTML = detailsHtml;
                    
                    // Add event listeners for radio buttons if round trip
                    if (isRoundTrip) {
                        document.querySelectorAll('input[name="flightSlice"]').forEach(radio => {
                            radio.addEventListener('change', (e) => {
                                renderSliceDetails(parseInt(e.target.value));
                            });
                        });
                    }
                };
                
                // Render initial slice
                renderSliceDetails(currentSliceIndex);
                
                // Show modal
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
            
            closeFlightDetailsModal() {
                const modal = document.getElementById('flightDetailsModal');
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }

            async proceedToPayment() {
                const proceedBtn = document.getElementById('proceed-payment-btn');
                const loadingIcon = document.getElementById('payment-loading');
                const messagesDiv = document.getElementById('messages');
                
                try {
                    // Show loading state
                    proceedBtn.disabled = true;
                    loadingIcon.classList.remove('hidden');
                    messagesDiv.innerHTML = '<div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded">Creating booking and preparing payment...</div>';
                    
                    console.log('üöÄ Creating TripZip booking...');
                    
                    // Get access token
                    const accessToken = localStorage.getItem('access_token');
                    if (!accessToken) {
                        throw new Error('Please login first to create booking');
                    }
                    
                    // Calculate adjusted amount based on passenger count
                    const passengerCount = this.bookingData.passengers ? this.bookingData.passengers.length : 0;
                    const baseAmount = parseFloat(this.bookingData.total_amount);
                    const adjustedAmount = passengerCount > 0 ? baseAmount * passengerCount : baseAmount;
                    
                    // Prepare TripZip booking data
                    const tripzipBookingData = {
                        passengers: this.bookingData.passengers,
                        flightDetails: this.bookingData.flightDetails,
                        amount: adjustedAmount,
                        currency: this.bookingData.total_currency,
                        offer_id: this.bookingData.offer_id
                    };
                    
                    // Create TripZip booking
                    const tripzipResponse = await axios.post('/api/create-tripzip-booking', tripzipBookingData, {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });
                    
                    if (tripzipResponse.data.status !== 'true') {
                        throw new Error(tripzipResponse.data.message || 'TripZip booking creation failed');
                    }
                    
                    const { booking, checkout_url } = tripzipResponse.data.data;
                    const booking_id = booking.id;
                    
                    console.log('‚úÖ TripZip booking created:', booking_id);
                    console.log('üîó Redirecting to Stripe checkout...');
                    
                    // Store booking ID and data for later use
                    localStorage.setItem('tripzip_booking_id', booking_id);
                    localStorage.setItem('bookingData', JSON.stringify(this.bookingData));
                    
                    // Show success message briefly then redirect
                    messagesDiv.innerHTML = '<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">Booking created successfully! Redirecting to payment...</div>';
                    
                    setTimeout(() => {
                        window.location.href = checkout_url;
                    }, 1500);
                    
                } catch (error) {
                    console.error('‚ùå Booking creation error:', error);
                    
                    // Reset loading state
                    proceedBtn.disabled = false;
                    loadingIcon.classList.add('hidden');
                    
                    const errorMsg = error.response?.data?.message || error.message || 'Booking creation failed';
                    messagesDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">Error: ${errorMsg}</div>`;
                }
            }
        }

        // Global variable for booking manager
        let bookingManager;
        let existingTravellers = []; // Store existing travellers from API
        
        /**
         * Complete Duffel booking after successful Stripe payment
         */
        async function completeBookingAfterPayment(paymentIntentId) {
            console.log('üí≥ Completing Duffel booking after successful payment:', paymentIntentId);
            
            try {
                // Show loading state (with fallback if LoaderManager not loaded yet)
                if (typeof LoaderManager !== 'undefined' && LoaderManager.showGlobalLoader) {
                    LoaderManager.showGlobalLoader('Completing your booking...');
                } else {
                    console.log('‚è≥ LoaderManager not available, completing booking...');
                }
                
                // Retrieve stored booking data
                const storedBookingData = localStorage.getItem('pending_booking_data');
                if (!storedBookingData) {
                    throw new Error('No booking data found in localStorage');
                }
                
                const bookingData = JSON.parse(storedBookingData);
                console.log('üìã Retrieved booking data:', bookingData);
                
                // Validate that passengers have Duffel IDs
                if (!bookingData.passengers || bookingData.passengers.length === 0) {
                    throw new Error('No passengers found in booking data');
                }
                
                // Check if passengers have the required Duffel ID field
                const passengersWithIds = bookingData.passengers.filter(p => p.id);
                if (passengersWithIds.length !== bookingData.passengers.length) {
                    console.error('‚ùå Some passengers missing Duffel IDs:', bookingData.passengers);
                    throw new Error('Some passengers are missing required Duffel IDs');
                }
                
                console.log('‚úÖ All passengers have Duffel IDs:', passengersWithIds);
                
                // Prepare booking payload for Duffel API
                const bookingPayload = {
                    offer_id: bookingData.selectedOffer.id,
                    passengers: bookingData.passengers.map(passenger => ({
                        // Preserve the Duffel ID (CRITICAL!)
                        id: passenger.id,
                        type: passenger.type,
                        title: passenger.title,
                        given_name: passenger.given_name,
                        family_name: passenger.family_name,
                        email: passenger.email,
                        phone_number: passenger.phone_number,
                        born_on: passenger.born_on,
                        gender: passenger.gender,
                        age: passenger.age,
                        loyalty_programme_accounts: passenger.loyalty_programme_accounts || []
                    })),
                    total_amount: bookingData.selectedOffer.total_amount,
                    total_currency: bookingData.selectedOffer.total_currency,
                    payment_intent_id: paymentIntentId // Include payment reference
                };
                
                console.log('üì§ Sending Duffel booking request:', bookingPayload);
                
                // Make the actual Duffel booking request
                const response = await axios.post('/api/book-flight', bookingPayload, {
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    timeout: 30000 // 30 second timeout
                });
                
                console.log('‚úÖ Duffel booking successful:', response.data);
                
                // Store the booking result
                localStorage.setItem('booking_confirmation', JSON.stringify(response.data));
                
                // Clean up temporary data
                localStorage.removeItem('pending_booking_data');
                
                // Show success message
                if (typeof LoaderManager !== 'undefined' && LoaderManager.hideGlobalLoader) {
                    LoaderManager.hideGlobalLoader();
                }
                showBookingSuccess(response.data);
                
            } catch (error) {
                console.error('‚ùå Duffel booking failed:', error);
                if (typeof LoaderManager !== 'undefined' && LoaderManager.hideGlobalLoader) {
                    LoaderManager.hideGlobalLoader();
                }
                
                // Show detailed error information
                let errorMessage = 'Failed to complete booking';
                if (error.response && error.response.data) {
                    console.error('Server error details:', error.response.data);
                    if (error.response.data.errors) {
                        errorMessage = error.response.data.errors.map(e => e.message).join(', ');
                    }
                }
                
                showBookingError(errorMessage);
            }
        }
        
        /**
         * Show booking success
         */
        function showBookingSuccess(bookingData) {
            document.body.innerHTML = `
                <div class="min-h-screen bg-green-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center">
                        <div class="text-green-500 text-6xl mb-4">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-800 mb-4">Booking Confirmed!</h1>
                        <p class="text-gray-600 mb-4">Your flight has been successfully booked.</p>
                        
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <p class="text-sm text-gray-600">Booking Reference</p>
                            <p class="text-lg font-bold text-gray-800">${bookingData.data?.booking_reference || 'N/A'}</p>
                        </div>
                        
                        <div class="space-y-2">
                            <button onclick="window.location.href='/dashboard/bookings.html'" 
                                    class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
                                View My Bookings
                            </button>
                            <button onclick="window.location.href='/flights.html'" 
                                    class="w-full bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400">
                                Search New Flight
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Show booking error
         */
        function showBookingError(errorMessage) {
            document.body.innerHTML = `
                <div class="min-h-screen bg-red-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center">
                        <div class="text-red-500 text-6xl mb-4">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-800 mb-4">Booking Failed</h1>
                        <p class="text-gray-600 mb-4">We couldn't complete your booking.</p>
                        
                        <div class="bg-red-50 border border-red-200 p-4 rounded-lg mb-6">
                            <p class="text-sm text-red-600">${errorMessage}</p>
                        </div>
                        
                        <div class="space-y-2">
                            <button onclick="window.location.reload()" 
                                    class="w-full bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700">
                                Try Again
                            </button>
                            <button onclick="window.location.href='/flights.html'" 
                                    class="w-full bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400">
                                Search New Flight
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Loader Management Functions
        const LoaderManager = {
            // Hide global loader
            hideGlobalLoader() {
                const globalLoader = document.getElementById('global-loader');
                if (globalLoader) {
                    globalLoader.style.opacity = '0';
                    setTimeout(() => {
                        globalLoader.style.display = 'none';
                    }, 300);
                }
            },
            
            // Show section content and hide section loader
            showSection(sectionName) {
                const loader = document.getElementById(`${sectionName}-loader`);
                let content = document.getElementById(`${sectionName}-content`) || document.getElementById(sectionName);
                
                // Special case for passenger forms
                if (sectionName === 'passenger-forms') {
                    content = document.getElementById('passenger-forms-container');
                }
                
                if (loader) {
                    loader.style.display = 'none';
                }
                if (content) {
                    content.classList.remove('hidden');
                    content.classList.add('fade-in');
                }
            },
            
            // Hide section loader (for sections without content containers)
            hideLoader(loaderId) {
                const loader = document.getElementById(loaderId);
                if (loader) {
                    loader.style.display = 'none';
                }
            },
            
            // Show all sections when everything is loaded
            showAllSections() {
                this.showSection('flight-details');
                this.showSection('passenger-forms-container');  
                this.showSection('price-details');
                this.hideGlobalLoader();
            }
        };

        // Load existing travellers from API
        async function loadExistingTravellers() {
            try {
                const token = localStorage.getItem('access_token');
                console.log('üîë Access token check:', token ? 'Found' : 'Missing');
                if (!token) {
                    console.log('‚ùå No access token found, skipping traveller loading');
                    console.log('üí° Please login first to load saved travellers');
                    return;
                }
                
                const baseUrl = await getBaseUrl();
                console.log('üåê Base URL resolved to:', baseUrl);
                console.log('üåê Loading travellers from:', `${baseUrl}/v1/users/travelers`);
                console.log('üîë Using Bearer token:', `Bearer ${token.substring(0, 20)}...`);
                
                const response = await axios.get(`${baseUrl}/v1/users/travelers`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('üì• Raw Travellers API response:', response);
                console.log('üì• Response data:', response.data);
                console.log('üì• Response status:', response.status);
                
                if (response.data.status === 'true' || response.data.status === true) {
                    // Extract travelers from the API response structure
                    existingTravellers = response.data.data?.travelers || [];
                    console.log('‚úÖ Loaded existing travellers:', existingTravellers);
                    console.log(`üìä Found ${existingTravellers.length} travellers`);
                    
                    // Populate dropdowns after loading travellers (in case forms are already rendered)
                    setTimeout(() => {
                        if (bookingManager && bookingManager.bookingData) {
                            console.log('üîÑ Populating dropdowns after traveller load...');
                            populateTravellerDropdowns();
                        }
                    }, 100);
                    
                } else {
                    console.warn('‚ö†Ô∏è Failed to load travellers:', response.data.message);
                    existingTravellers = [];
                }
                
            } catch (error) {
                console.error('‚ùå Error loading existing travellers:', error);
                console.error('Error details:', error.response?.data || error.message);
                existingTravellers = [];
            }
        }

        // Test function to manually trigger traveller loading (for debugging)
        window.testTravellers = async function() {
            console.log('üß™ Manual test: Loading travellers...');
            await loadExistingTravellers();
            if (existingTravellers.length > 0) {
                populateTravellerDropdowns();
            }
        };

        // Get base URL from config
        async function getBaseUrl() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                return config.apiBaseUrl;
            } catch (error) {
                return 'https://api.tripzip.ai'; // Fallback
            }
        }

        // Populate traveller dropdowns after forms are generated
        // Make function globally available
        window.populateTravellerDropdowns = function populateTravellerDropdowns() {
            console.log('üéØ populateTravellerDropdowns called');
            console.log('üéØ bookingManager exists:', !!bookingManager);
            console.log('üéØ bookingData exists:', !!bookingManager?.bookingData);
            console.log('üéØ passengers exists:', !!bookingManager?.bookingData?.passengers);
            
            if (!bookingManager || !bookingManager.bookingData || !bookingManager.bookingData.passengers) {
                console.warn('‚ùå Booking manager or passengers not ready');
                return;
            }
            
            const passengers = bookingManager.bookingData.passengers;
            console.log('üë• Passengers to process:', passengers.length);
            console.log('üë• Passenger details:', passengers);
            console.log('üß≥ Available travellers count:', existingTravellers.length);
            console.log('üß≥ Available travellers data:', existingTravellers);
            
            passengers.forEach((passenger, index) => {
                const select = document.getElementById(`travellerSelect_${index}`);
                console.log(`Processing passenger ${index}, select element:`, select);
                
                if (select) {
                    // Clear existing options except the default
                    select.innerHTML = '<option value="">Choose existing traveller...</option>';
                    
                    if (existingTravellers.length > 0) {
                        // Add travellers to dropdown - filter by passenger type for better UX
                        const passengerType = passenger.type;
                        console.log(`Passenger ${index} type: ${passengerType}`);
                        
                        const compatibleTravellers = existingTravellers.filter(traveller => {
                            // Adults can use any adult travellers
                            if (passengerType === 'adult') return traveller.passenger_type === 'adult';
                            // Children and infants can use child, infant, or adult travellers  
                            return traveller.passenger_type === 'adult' || 
                                   traveller.passenger_type === 'child' || 
                                   traveller.passenger_type === 'infant';
                        });
                        
                        console.log(`Compatible travellers for passenger ${index}:`, compatibleTravellers);
                        
                        compatibleTravellers.forEach(traveller => {
                            const option = document.createElement('option');
                            option.value = traveller.id;
                            option.textContent = `${traveller.first_name} ${traveller.last_name} (${traveller.passenger_type})`;
                            select.appendChild(option);
                            console.log(`Added option: ${option.textContent}`);
                        });
                    } else {
                        console.log('No existing travellers found');
                    }
                }
            });
        }

        // Populate form fields from selected traveller
        function populateFromTraveller(passengerIndex) {
            const select = document.getElementById(`travellerSelect_${passengerIndex}`);
            const travellerId = select.value;
            
            if (!travellerId) return;
            
            const traveller = existingTravellers.find(t => t.id === travellerId);
            if (!traveller) {
                console.warn('Traveller not found:', travellerId);
                return;
            }
            
            console.log('Populating with traveller:', traveller);
            
            // Populate form fields
            const titleField = document.querySelector(`[data-passenger-index="${passengerIndex}"] .passenger-title`);
            const firstNameField = document.querySelector(`[data-passenger-index="${passengerIndex}"] .passenger-first-name`);
            const lastNameField = document.querySelector(`[data-passenger-index="${passengerIndex}"] .passenger-last-name`);
            const dobField = document.querySelector(`[data-passenger-index="${passengerIndex}"] .passenger-dob`);
            const genderField = document.querySelector(`[data-passenger-index="${passengerIndex}"] .passenger-gender`);
            const emailField = document.querySelector(`[data-passenger-index="${passengerIndex}"] .passenger-email`);
            const countryCodeField = document.querySelector(`[data-passenger-index="${passengerIndex}"] .passenger-country-code`);
            const phoneNumberField = document.querySelector(`[data-passenger-index="${passengerIndex}"] .passenger-phone-number`);
            
            // Map title from API format ("Mr." -> "mr")
            if (titleField && traveller.title) {
                const titleValue = traveller.title.toLowerCase().replace('.', '');
                titleField.value = titleValue;
                console.log('Set title:', titleValue);
            }
            
            // Set name fields
            if (firstNameField && traveller.first_name) {
                firstNameField.value = traveller.first_name;
                console.log('Set first name:', traveller.first_name);
            }
            
            if (lastNameField && traveller.last_name) {
                lastNameField.value = traveller.last_name;
                console.log('Set last name:', traveller.last_name);
            }
            
            // Set date of birth
            if (dobField && traveller.date_of_birth) {
                dobField.value = traveller.date_of_birth;
                console.log('Set DOB:', traveller.date_of_birth);
            }
            
            // Set gender (map from API format if needed)
            if (genderField && traveller.gender) {
                // Assume API returns gender as 'Male'/'Female' or 'M'/'F'
                const genderValue = traveller.gender.toLowerCase().charAt(0); // 'm' or 'f'
                genderField.value = genderValue;
                console.log('Set gender:', genderValue);
            }
            
            // For adults, also populate email and phone
            const passenger = bookingManager.bookingData.passengers[passengerIndex];
            if (passenger.type === 'adult') {
                if (emailField && traveller.email) {
                    emailField.value = traveller.email;
                    console.log('Set email:', traveller.email);
                }
                
                if (countryCodeField && phoneNumberField && traveller.phone_number) {
                    // Extract country code and number from full phone number
                    const phoneNumber = traveller.phone_number;
                    const countryCodeMatch = phoneNumber.match(/^(\+\d{1,4})/);
                    
                    if (countryCodeMatch) {
                        const countryCode = countryCodeMatch[1];
                        const numberPart = phoneNumber.replace(countryCode, '');
                        
                        countryCodeField.value = countryCode;
                        phoneNumberField.value = numberPart;
                        
                        // Also update the visible country search input
                        const countrySearchField = document.querySelector(`[data-passenger-index="${passengerIndex}"] .passenger-country-search`);
                        if (countrySearchField) {
                            countrySearchField.value = window.getCountryDisplay(countryCode);
                        }
                        
                        console.log('Set phone:', countryCode, numberPart);
                    } else {
                        // Default to +880 if no country code detected
                        countryCodeField.value = '+880';
                        phoneNumberField.value = phoneNumber;
                        
                        // Update visible search field
                        const countrySearchField = document.querySelector(`[data-passenger-index="${passengerIndex}"] .passenger-country-search`);
                        if (countrySearchField) {
                            countrySearchField.value = 'ÔøΩÔøΩ +880';
                        }
                    }
                }
            }
            
            // Trigger input events to save the data
            [titleField, firstNameField, lastNameField, dobField, genderField, emailField, countryCodeField, phoneNumberField].forEach(field => {
                if (field && field.value) {
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
            
            console.log(`‚úÖ Populated passenger ${passengerIndex} with traveller:`, traveller.first_name + ' ' + traveller.last_name);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Page loaded, initializing...');
            
            // Load nationalities data
            console.log('üåç Loading nationalities...');
            await window.loadNationalities();
            
            // üéØ CRITICAL: Check if returning from Stripe payment
            const urlParams = new URLSearchParams(window.location.search);
            const paymentIntent = urlParams.get('payment_intent');
            const paymentIntentClientSecret = urlParams.get('payment_intent_client_secret');
            const redirectStatus = urlParams.get('redirect_status');
            
            if (paymentIntent && redirectStatus === 'succeeded') {
                console.log('üéØ STRIPE PAYMENT SUCCESS DETECTED!');
                console.log('Payment Intent:', paymentIntent);
                
                // Complete the Duffel booking immediately
                await completeBookingAfterPayment(paymentIntent);
                return; // Don't continue with normal page initialization
            }
            
            // Note: Navigation auto-initializes for non-dashboard pages via nav.js
            
            console.log('üîë Checking access token...');
            const token = localStorage.getItem('access_token');
            console.log('Access token exists:', !!token);
            
            // Initialize booking summary immediately (don't wait for travellers)
            console.log('ÔøΩ Initializing booking manager...');
            bookingManager = new BookingSummaryManager();
            
            // Load existing travellers in parallel (non-blocking)
            console.log('ÔøΩ Loading travellers in background...');
            loadExistingTravellers().then(() => {
                console.log('‚úÖ Travellers loaded, populating dropdowns if forms are ready...');
                // Populate dropdowns if forms are already rendered
                if (document.querySelector('.passenger-title')) {
                    window.populateTravellerDropdowns();
                }
            }).catch(error => {
                console.warn('‚ö†Ô∏è Travellers loading failed:', error);
            });
            
            // Hide global loader after sections load
            setTimeout(() => {
                LoaderManager.hideGlobalLoader();
            }, 500); // Much faster global loader timeout
        });
    </script>

    <script src="components/booking-timer.js"></script>
    <script>
        // Initialize booking timer
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Fetch timer duration from config
                const configResponse = await fetch('/api/config');
                const config = await configResponse.json();
                const timerDuration = config.booking_timer_minutes || 15;
                
                console.log('‚è∞ Initializing booking timer with duration:', timerDuration, 'minutes');
                
                // Initialize timer
                const timer = new BookingTimer('booking-timer-container', {
                    timerDuration: timerDuration,
                    onExpire: () => {
                        // Clear booking data
                        localStorage.removeItem('pending_booking_data');
                        localStorage.removeItem('booking_timer_start');
                        
                        // Show the timer expired modal
                        const modal = document.getElementById('timerExpiredModal');
                        modal.classList.remove('hidden');
                        document.body.style.overflow = 'hidden';
                        
                        // Setup go to home button
                        const goToHomeBtn = document.getElementById('goToHomeBtn');
                        goToHomeBtn.onclick = () => {
                            window.location.href = '/';
                        };
                    }
                });
                
                // Clean up timer on page unload
                window.addEventListener('beforeunload', () => {
                    if (timer) {
                        timer.destroy();
                    }
                });
                
            } catch (error) {
                console.error('Error initializing booking timer:', error);
            }
        });
    </script>

    <script src="components/footer.js"></script>
</body>
</html>